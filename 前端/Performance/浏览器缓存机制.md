## 浏览器缓存

浏览器缓存分为强制缓存和协商缓存，强制缓存的优先级高于协商缓存。

## 强制缓存

* 浏览器在向服务器请求资源之前，会先向浏览器缓存查找是否命中强缓存，如果命中强缓存，就直接使用缓存中的资源。

* 浏览器在向服务器发送请求时，如果服务器设置了缓存规则，会将缓存规则放置在响应头中返回给浏览器，响应头中的 Expires 和 Cache-Control 字段表示强制缓存的规则。Cache-Control 的优先级高于 Expires。

    * Expires
        
        * HTTP1.0 中控制缓存规则的字段，值是一个绝对的时间值，表示缓存到期失效时间。
        * 当客户端的时间小于 Expires 字段中的时间值，浏览器会直接读取缓存中的资源，否则就代表强制缓存失效，将采用协商缓存。
        * Expires 存在的缺陷就是判断缓存是否失效的方式是用客户端的时间和 Expires 字段值比较，但是客户端的时间是可以随意更改，这样会导致判断结果并不准确。
    
    * Cache-Control
        
        * HTTP1.1 中控制缓存规则的字段，值可以拥有多个属性。当值中包含了 max-age 属性，表示的是缓存的最大有效时长，单位是秒。 
        * max-age 的值是一个相对时间，根据浏览器第一次请求的时间和 max-age 设定的时间，计算出缓存的有效时间，用有效时间和当前请求资源时间做比较，请求资源时间小于有效时间就表示强缓存生效，否则失效。

* 强制缓存中的资源会分别存储在内存和硬盘中，也就是 from memory cache 和 from disk cache。

  ![image](https://user-images.githubusercontent.com/20440496/41962055-aae47cdc-7a26-11e8-8cf2-8a03dc279f66.png)           

## 协商缓存

* 强制缓存失效后，将会采用协商缓存。

* 强制缓存失效后，浏览器会携带缓存标识向服务端发送请求，由服务端确认是否命中协商缓存,如果命中命中协商缓存，浏览器的请求 http 状态是 304，就直接使用缓存中的资源，如果没命中协商缓存，服务器会返回最新的资源以及携带的缓存规则给浏览器，浏览器会将缓存规则和资源重新放入到浏览器缓存中。

* 协商缓存是由请求头和响应头中的字段 【Last-Modified，If-Modified-Since】，【ETag、If-None-Match】管理的，字段同时存在时，【ETag、If-None-Match】的优先级高于 【Last-Modified，If-Modified-Since】。

    * 【Last-Modified，If-Modified-Since】
    
        * Last-Modified: 是浏览器向服务器发送请求时，服务端返回的响应头字段，值是一个绝对时间，表示请求的资源最后修改的时间。
        * If-Modified-Since: 浏览器在向服务器发送请求时，在请求头中会加上该字段，字段的值就是上一次请求时服务端返回的  Last-Modified 值。服务端会判断携带的 If-Modified-Since 值和服务器上的 Last-Modified 值是否一致，一致的话就表示资源没有被更新过，命中协商缓存，服务端返回 304 状态码。

    * 【ETag、If-None-Match】

        * ETag: 浏览器向服务器发送请求时，服务端会为请求的资源生成一个唯一标识，只要资源修改过就会重新生成标识。
        * If-None-Match:  浏览器在向服务器发送请求时，在请求头中会加上该字段，字段的值就是上一次请求时服务端返回的  ETag 值。服务端会判断携带的 If-None-Match 值和服务器上的 ETag 值是否一致，一致的话就表示资源没有被更新过，命中协商缓存，服务端返回 304 状态码。

## 浏览器行为对缓存的影响        

* f5 手动刷新页面: 跳过强制缓存，进行协商缓存检测。

* Ctrl+f5 强制刷新: 忽略掉强制缓存和协商缓存，从服务器重新拉去资源。这也就是为什么当页面有缓存时，强制刷新页面就能清除浏览器缓存的原因。 

## 总结

* 第一次访问页面时，浏览器向服务器拉取资源，并将资源和缓存规则保存在浏览器缓存中。
* 再次访问页面时，浏览器会先去缓存中检测强制缓存是否生效，强制缓存生效直接取缓存中的资源，失效则进行协商缓存检测。
* 协商缓存会发起请求，由服务器判定协商缓存是否生效，协商缓存生效，服务器会返回 304 状态码表示可以继续使用缓存中的资源，协商缓存失效则会重新返回资源和缓存规则，并将新的资源和缓存规则保存在浏览器缓存中。

## 参考

* [https://mp.weixin.qq.com/s/d2zeGhUptGUGJpB5xHQbOA](https://mp.weixin.qq.com/s/d2zeGhUptGUGJpB5xHQbOA)

* [https://segmentfault.com/a/1190000011212929](https://segmentfault.com/a/1190000011212929)

* [https://github.com/axuebin/articles/issues/10](https://github.com/axuebin/articles/issues/10)